"use strict";(self.webpackChunkcritical_web=self.webpackChunkcritical_web||[]).push([[931],{1970:(j,N,d)=>{d.d(N,{P:()=>C});var a=d(9212),u=d(2181);class i{create(){return{svg:null,mainG:null,innerWidth:null,innerHeight:null,margin:{top:60,right:90,bottom:100,left:90},scales:null,focusLine:null,selected:null,head:null,latestId:0,latestGroupId:0,seedProject:null}}}var p=d(3920),S=d(3633),c=d(4595),y=d(2119),v=d(9975),m=d(8962);let f=(()=>{class h{constructor(t,e,s,r){this.dashboard=t,this.projSerializer=e,this.treeNodeSerializer=s,this.nodeConnector=r}setState(t){this.st=t}initializeHeadNode(t){const e=this.projSerializer,s=e.fromJson(t),r=this.treeNodeSerializer.head();r.data=s,this.st.head=r,this.st.selected=r,this.st.seedProject=e.fromJson(t)}countNodes(t,e){e.push(t);for(const s of t.children)this.countNodes(s,e);return e.length>0?Math.max(...e.map(s=>s.id?s.id:0))+1:0}selectNode(t){const e=this.getNodeById(this.st.head,t);e&&(this.st.selected=this.copyNode(e))}getNodeById(t,e){if(t.id===e)return t;let s=null;for(const r of t.children){const n=this.getNodeById(r,e);n&&(s=n)}return s}commit(t){const e=this.createNode(t);return this.st.selected.children.push(e),e.parent=this.st.selected,e.parentNodeId=this.st.selected.id,this.st.selected=e,this.getHistoryArray(this.st.head)}branch(t){if(null!=this.st.selected.parent){this.st.selected=this.st.selected.parent;const e=this.createNode(t);return e.parent=this.st.selected,e.parentNodeId=this.st.selected.id,this.st.selected.children.push(e),this.st.selected=e,this.getHistoryArray(this.st.head)}return null}reset(){const t=(new y.z).fromJson(this.st.seedProject),e=this.copyNode(this.st.head);return e.data=t,e.children=[],this.st.head=e,this.st.selected=this.copyNode(e),e}deleteNode(){if(null!=this.st.selected.parent){const t=this.st.selected;return this.st.selected=this.st.selected.parent,this.st.selected.children=this.st.selected.children.filter(e=>e.id!==t.id),this.pruneNode(this.st.head,t.id),this.getHistoryArray(this.st.head)}return[]}copyNode(t){const e=(new y.z).fromJson(t.data),s=(new v.Q).fromJson(t);return e.profile.view.lassoOn=t.data.profile.view.lassoOn,s.data=e,s}pruneNode(t,e){if(t.id===e)return!0;let s=!1;for(const r of t.children)s=s||this.pruneNode(r,e);return s&&(t.children=t.children.filter(r=>r.id!==e)),!1}createNode(t){const e=this.st.selected;this.st.latestId++;let s=null,r=null;const n=this.st.latestId;e.children.length>0?(this.st.latestGroupId++,s=this.st.latestGroupId,r=0):(s=e.group,r=e.subgroup+1);const l=`${s}-${r}-${n}`,o=this.projSerializer.fromJson(t);o.profile.view.lassoOn=t.profile.view.lassoOn;const _={id:n,group:s,subgroup:r,data:o,name:l,children:[],metadata:null,parent:null,parentNodeId:null};return this.nodeConnector.connectArrowsToNodes(o),this.processMetadata(_),_}processMetadata(t){const r={assignmentCompleted:0===t.data.activities.filter(n=>!n.chartInfo.isDummy).filter(n=>0===n.assign.resources.length).length,time:null,cost:null};t.metadata=r}getHistoryArray(t){const e=[];return this.walkTree(t,e,0),e}walkTree(t,e,s){if(!t)return;const r=this.projSerializer.fromJson(t.data),n=this.treeNodeSerializer.fromJson(t);this.nodeConnector.connectArrowsToNodes(r),n.data=r,e.push(n);for(const l of t.children)this.walkTree(l,e,++s)}loadState(t,e){const s=e.find(l=>0===l.id),r=this.copyNode(s);r.data=this.projSerializer.fromJson(s.data),t.head=r,t.selected=r,t.seedProject=this.projSerializer.fromJson(t.head.data);const n=e.map(l=>l.id);return t.latestId=Math.max(...n)+1,t.latestGroupId=c.Iz,this.buildBranch(t.head,e,null),e.forEach(l=>this.nodeConnector.connectArrowsToNodes(l.data)),this.projSerializer.fromJson(s.data)}buildBranch(t,e,s){if(t){s&&(s.children.push(t),t.parent=s);const r=e.filter(n=>n.parentNodeId===t.id&&null!==n.parentNodeId);for(const n of r)this.buildBranch(n,e,t)}}static#t=this.\u0275fac=function(e){return new(e||h)(a.LFG(S.Ou),a.LFG(y.z),a.LFG(v.Q),a.LFG(m.E))};static#e=this.\u0275prov=a.Yz7({token:h,factory:h.\u0275fac,providedIn:"root"})}return h})();var T=d(2425);let g=(()=>{class h{constructor(t,e,s,r,n,l){this.dashboard=t,this.eventService=e,this.projectSerializer=s,this.ops=r,this.toastr=n,this.ngZone=l,this.isInitialized=!1,this.subsInited=!1}initSubscriptions(){this.subsInited||(this.selectedNode$=this.eventService.get(c.Xq),this.commitSub=this.eventService.get(c.J7).pipe((0,u.h)(t=>!!t)).subscribe(t=>this.commit()),this.branchSub=this.eventService.get(c.u0).pipe((0,u.h)(t=>!!t)).subscribe(t=>this.branch()),this.resetSub=this.eventService.get(c.NT).pipe((0,u.h)(t=>!!t)).subscribe(t=>this.reset()),this.loadTreeSub=this.eventService.get(c.kV).pipe((0,u.h)(t=>!!t)).subscribe(t=>this.loadTree(t)),this.selectedNode$.pipe((0,u.h)(t=>void 0!==t)).subscribe(t=>this.selectNode(t)),this.subsInited=!0)}commit(){const t=this.ops.commit(this.project);this.eventService.get(c.cu).next(t),null!==this.st.selected&&this.selectedNode$.next(this.st.selected.id),this.dashboard.resetUndoRedo(),this.drawChart()}branch(){const t=this.ops.branch(this.project);this.eventService.get(c.cu).next(t),null!==this.st.selected&&this.selectedNode$.next(this.st.selected.id),this.dashboard.resetUndoRedo(),this.drawChart()}reset(){let t=[];if(this.st.selected===this.st.head){const e=this.ops.reset(),s=this.projectSerializer.fromJson(e.data);this.dashboard.updateProject(s,!0)}else t=this.ops.deleteNode(),this.dashboard.updateProject(this.st.selected.data,!0);null!==this.st.selected&&this.selectedNode$.next(this.st.selected.id),this.eventService.get(c.cu).next(t),this.dashboard.resetUndoRedo(),this.drawChart()}loadTree(t){try{this.st=this.st??(new i).create();const e=this.ops.loadState(this.st,t);this.dashboard.updateProject(e,!0),this.dashboard.resetUndoRedo(),this.eventService.get(c.cu).next(t),this.drawChart()}catch(e){console.error("Exception",e),this.toastr.error("Loading file failed, check file format","Error")}}selectNode(t){this.ops.selectNode(t),null!==this.st.selected&&null!==this.st.selected.data&&this.dashboard.updateProject(this.st.selected.data,!0),this.drawChart()}init(t,e,s,r){this.id=s,this.st=this.st??(new i).create(),this.st.latestId=c.Iz,this.st.innerHeight=e-this.st.margin.top-this.st.margin.bottom,this.st.innerWidth=t-this.st.margin.left-this.st.margin.right,this.ops.setState(this.st),this.initSvg(t,e,r),this.initZoom(),this.dashboard.activeProject$.pipe((0,u.h)(n=>!!n)).subscribe(n=>{this.ngZone.runOutsideAngular(()=>{this.project=n,this.isInitialized||(this.ops.initializeHeadNode(n),this.drawChart()),this.isInitialized=!0})}),this.initSubscriptions()}initZoom(){const t=p.sPX().on("zoom",(e,s)=>{this.st.mainG.attr("transform",e.transform)}).scaleExtent([1,1]);this.st.svg.call(t),p.sPX().translateBy(this.st.svg,this.st.margin.left,this.st.margin.top)}destroy(){this.reset(),this.commitSub&&this.commitSub.unsubscribe(),this.branchSub&&this.branchSub.unsubscribe(),this.resetSub&&this.resetSub.unsubscribe(),this.loadTreeSub&&this.loadTreeSub.unsubscribe(),this.eventService.get(c.J7).next(null),this.eventService.get(c.u0).next(null),this.eventService.get(c.NT).next(null),this.eventService.get(c.cu).next(null)}initSvg(t,e,s){const r=this.st,n="tree-s-"+this.id;p.Ys(s).select("svg").remove();const l=p.Ys(s).append("svg").attr("class",n);this.st.svg=l.style("width","100%").style("height",null).attr("preserveAspectRatio","xMinYMin meet").attr("viewBox",`0 0 ${t} ${e}`),r.mainG=r.svg.append("g").attr("transform","translate("+this.st.margin.left+","+this.st.margin.top+")")}drawChart(){if(!this.st.mainG)return;this.st.mainG.selectAll("*").remove();let t=p.G_s().size([this.st.innerHeight,this.st.innerWidth]);const e=p.bT9(this.st.head);t=t.size([this.st.innerWidth,75*e.height]);const r=t(e),n=e.descendants().slice(1);this.st.mainG.selectAll(".link-tree").data(n).enter().append("path").attr("class","link-tree").attr("stroke","2px").attr("d",o=>"M"+o.x+","+o.y+"C"+o.x+","+(o.y+o.parent.y)/2+" "+o.parent.x+","+(o.y+o.parent.y)/2+" "+o.parent.x+","+o.parent.y);const l=this.st.mainG.selectAll(".node-tree").data(r.descendants()).enter().append("g");l.append("circle").attr("class","node-tree").attr("r",8).attr("cx",o=>o.x).attr("cy",o=>o.y).classed("selected",o=>o.data?.id===this.st.selected?.id).classed("completed",o=>!!o.data?.metadata?.assignmentCompleted).on("mousedown",(o,_)=>{this.selectedNode$.next(_.data.id),this.st.selected=_.data;const w=(new y.z).fromJson(_.data.data);this.dashboard.updateProject(w,!0),this.drawChart()}),l.append("text").text(o=>o.data.name).attr("x",o=>o.x).attr("dx",8.5).attr("y",o=>o.y)}static#t=this.\u0275fac=function(e){return new(e||h)(a.LFG(S.Ou),a.LFG(S.WO),a.LFG(y.z),a.LFG(f),a.LFG(T._W),a.LFG(a.R0b))};static#e=this.\u0275prov=a.Yz7({token:h,factory:h.\u0275fac,providedIn:"root"})}return h})();const b=["chart"];let C=(()=>{class h{constructor(){this.ui=(0,a.f3M)(g)}ngOnInit(){this.ui.init(this.width,this.height,this.id,this.chart.nativeElement)}ngOnDestroy(){this.ui.destroy()}static#t=this.\u0275fac=function(e){return new(e||h)};static#e=this.\u0275cmp=a.Xpm({type:h,selectors:[["cp-project-tree"]],viewQuery:function(e,s){if(1&e&&a.Gf(b,7),2&e){let r;a.iGM(r=a.CRH())&&(s.chart=r.first)}},inputs:{id:"id",width:"width",height:"height"},features:[a._Bn([g])],decls:3,vars:0,consts:[[1,"node-tree"],[1,"project-tree"],["chart",""]],template:function(e,s){1&e&&(a.TgZ(0,"div",0),a._UZ(1,"div",1,2),a.qZA())},styles:["cp-project-tree text{stroke:#999}cp-project-tree svg{background-color:#fff}cp-project-tree .link-tree{fill:none;stroke:#000}cp-project-tree .border{fill:none;shape-rendering:crispEdges;stroke:#aaa}cp-project-tree .node-tree{stroke:#fff;fill:#000;cursor:pointer}cp-project-tree .node-tree.onpath{stroke:#6495ed;stroke-width:4px;fill:#d3d3d3}cp-project-tree .node-tree.selected{stroke:#6495ed;stroke-width:4px;fill:red}cp-project-tree .node-tree.selected.completed,cp-project-tree .node-tree.completed{stroke:#6495ed;stroke-width:4px;fill:#0e0}cp-project-tree .project-tree{margin-top:15px}\n"],encapsulation:2})}return h})()},2457:(j,N,d)=>{d.d(N,{n:()=>i});var a=d(6814),u=d(9212);let i=(()=>{class p{static#t=this.\u0275fac=function(y){return new(y||p)};static#e=this.\u0275mod=u.oAB({type:p});static#s=this.\u0275inj=u.cJS({imports:[a.ez]})}return p})()},5269:(j,N,d)=>{d.d(N,{u:()=>S});var a=d(3633),u=d(4595),i=d(9212),p=d(6602);let S=(()=>{class c{constructor(v,m){this.eventService=v,this.jsonFileManager=m,this.multiFileFormats=!1,this.eventService.get(u.cu).subscribe(f=>{this.history=f})}ngOnInit(){}commit(){this.eventService.get(u.J7).next(!0)}branch(){this.eventService.get(u.u0).next(!0)}deleteNode(){this.eventService.get(u.NT).next(!0)}downloadHistory(){this.jsonFileManager.export(this.history)}loadFile(v){const m=v.files,f=m.item(0);null!==f&&m.length>0&&this.jsonFileManager.importFromTreeNodeList(f).then(T=>{this.eventService.get(u.kV).next(T)})}static#t=this.\u0275fac=function(m){return new(m||c)(i.Y36(a.WO),i.Y36(p.W))};static#e=this.\u0275cmp=i.Xpm({type:c,selectors:[["cp-tree-buttons"]],inputs:{fileActions:"fileActions",multiFileFormats:"multiFileFormats"},decls:18,vars:1,consts:[[1,"btns"],["href","javascript:void(0)",3,"click"],[3,"hidden"],["type","file","accept",".json",1,"file-input",3,"change"],["uploadFile",""]],template:function(m,f){if(1&m){const T=i.EpF();i.TgZ(0,"div",0)(1,"div")(2,"a",1),i.NdJ("click",function(){return f.commit()}),i._uU(3,"Commit"),i.qZA(),i._uU(4," \xa0 | \xa0 "),i.TgZ(5,"a",1),i.NdJ("click",function(){return f.branch()}),i._uU(6,"Branch"),i.qZA(),i._uU(7," \xa0 | \xa0 "),i.TgZ(8,"a",1),i.NdJ("click",function(){return f.deleteNode()}),i._uU(9,"Delete"),i.qZA()(),i.TgZ(10,"div",2)(11,"a",1),i.NdJ("click",function(){return f.downloadHistory()}),i._uU(12,"Download"),i.qZA(),i._uU(13," \xa0 | \xa0 "),i.TgZ(14,"a",1),i.NdJ("click",function(){i.CHM(T);const b=i.MAs(17);return b.value="",i.KtG(b.click())}),i._uU(15,"Load File"),i.qZA(),i.TgZ(16,"input",3,4),i.NdJ("change",function(b){return f.loadFile(b.target)}),i.qZA()()()}2&m&&(i.xp6(10),i.Q6J("hidden",!f.fileActions))},styles:[".btns[_ngcontent-%COMP%]{display:flex;justify-content:space-between}.file-input[_ngcontent-%COMP%]{display:none}"]})}return c})()}}]);